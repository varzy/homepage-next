---
title: 'å¦‚ä½•æ›´ä¼˜é›…å¾—ç®¡ç†å°ç¨‹åºç‰ˆæœ¬'
category: 'Coding'
type: 'Post'
status: 'Published'
tags: ['Miniprogram', 'CICD']
date: '2021-03-12'
slug: 'miniprogram-version-managment'
summary: ''
last_edited_time: '2025-09-02T08:37:00.000Z'
blog_last_fetched_time: '2025-09-02T08:56:08.675Z'
notion_id: 'bd24e5bb-1a14-4947-b458-fbf4d902db35'
icon: 'ğŸ“'
---

æœ€è¿‘æˆ‘ä¹Ÿæ˜¯ä»å¤´å¼€å‘äº†ä¸€ä¸ªå°ç¨‹åºï¼Œå…¶ä¸­æœ€ boring çš„å¤§æ¦‚å°±æ˜¯å‘ç‰ˆã€‚è€Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¹Ÿåœ¨å‘å¸ƒç‰ˆæœ¬è¿™ä»¶äº‹ä¸Šç¢ç£¨äº†å¾ˆä¹…ï¼Œç›®å‰æ€»ç®—æ˜¯æäº†ä¸ªä¼¼ä¹ä¸èµ–çš„æ–¹æ³•ã€‚ä¸‹é¢å°±æŒ‰ç…§å¼€å‘æµç¨‹è®²ä¸€ä¸‹æˆ‘çš„å¿ƒè·¯å†ç¨‹ã€‚

## ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ç¯å¢ƒå˜é‡

å°ç¨‹åºç‰ˆæœ¬ç®¡ç†æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯è¦å°½å¯èƒ½ç®€å•å¾—åŒºåˆ†ä¸åŒçš„è¿è¡Œç¯å¢ƒã€‚ç”±äºå°ç¨‹åºä¸æ”¯æŒç±»ä¼¼ç¯å¢ƒå˜é‡çš„åŠŸèƒ½ï¼Œå› æ­¤éœ€è¦å¼€å‘è€…åœ¨ä»£ç å±‚é¢æ‰‹åŠ¨æ§åˆ¶ã€‚æˆ‘ä»¬ä¸“é—¨è®¾ç½®äº† `config/env.js` ç”¨äºæ§åˆ¶å°ç¨‹åºç¯å¢ƒï¼Œæ‰€æœ‰æ¶‰åŠè¿è¡Œç¯å¢ƒçš„åœ°æ–¹éƒ½è¦å¼•å…¥ `ENV` å¸¸é‡ã€‚æ¯”å¦‚æˆ‘ä»¬çš„æ¥å£ï¼š

```javascript
// config/env.js
// å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å®šä¹‰å„ç§ç¯å¢ƒã€‚æ¯”å¦‚æˆ‘ä»¬å®šä¹‰äº† DEV, STAGING, PROD ä¸‰ç§
export const ENV = 'DEV';

// config/constnts.js
import { ENV } from './env';
export const BASE_URL_API = ENV === 'DEV' ? æµ‹è¯•æ¥å£ : æ­£å¼æ¥å£;
```

æ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæ—¶ï¼Œéƒ½åªéœ€è¦æ›´æ”¹ `ENV` çš„å€¼å³å¯å®ç°ç¯å¢ƒåˆ‡æ¢ã€‚

## ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬å·æœºåˆ¶

å½“å°ç¨‹åºè¿›å…¥æµ‹è¯•é˜¶æ®µåï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å‘å¸ƒä¸“é—¨çš„ä½“éªŒç‰ˆç»™æµ‹è¯•åŒäº‹ä½¿ç”¨ã€‚ä½†ç»å¸¸ä¼šå‡ºç°è¿™æ ·çš„å¯¹è¯ğŸ¤¦â€â™€ï¸ï¼š

```plain text
æµ‹è¯•åŒäº‹ï¼šä½ æ”¹å¥½äº†å—ï¼Ÿ
æˆ‘ï¼šå¥½äº†å¥½äº†ï¼Œå·²ç»æäº¤æ–°ç‰ˆäº†ã€‚
æµ‹è¯•åŒäº‹ï¼šè¿˜æ˜¯æ²¡æœ‰å•Šï¼Ÿä½ å•¥æ—¶å€™æäº¤çš„ï¼Ÿ
æˆ‘ï¼šä½ æ‰“å¼€å°ç¨‹åºåŠ©æ‰‹ï¼Œäº”åˆ†é’Ÿå‰æ›´æ–°çš„é‚£ç‰ˆã€‚ã€‚ã€‚
```

å¹¶ä¸”ï¼Œç”±äºæˆ‘ä»¬çš„ Bug éœ€è¦å¸¦ä¸Šç‰ˆæœ¬å·åœ¨å›¢é˜Ÿåä½œå·¥å…·ä¸Šè¿›è¡Œè®°å½•ï¼Œå¦‚æœæ¯æ¬¡éƒ½è®°å½•ä½“éªŒç‰ˆçš„å‘å¸ƒæ—¶é—´ï¼Œå°†ä¼šéå¸¸ç¹çï¼Œå› æ­¤æˆ‘ä»¬ç¡®å®éœ€è¦ä¸€ä¸ªå¯å®æ–½æ€§æ›´å¼ºçš„ç‰ˆæœ¬æœºåˆ¶ã€‚

æˆ‘ä»¬å°ç¨‹åºä¼šæœ‰ä¸€ä¸ªä¸‰ä½çš„ã€ä¸¥æ ¼éµå¾ª [SemVer è§„èŒƒ](https://semver.org/lang/zh-CN/) çš„ä¸»ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ `2.1.3`ã€‚æƒ³è¦åŒºåˆ†æµ‹è¯•ç‰ˆæœ¬ï¼Œæœ€ç®€å•çš„å°±æ˜¯åœ¨è¿™ä¸ªä¸»ç‰ˆæœ¬å·åé¢å†åŠ ä¸€ä½ã€‚æ¯”å¦‚ï¼š`2.1.3.d1`ï¼Œå°±ä»£è¡¨è¿™æ˜¯ç”¨äºæµ‹è¯•çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œd ä»£è¡¨ DEV ç¯å¢ƒã€‚æ¯æ¬¡å‘å¸ƒæ–°çš„ä½“éªŒç‰ˆåï¼Œéƒ½éœ€è¦å°†åæ–¹çš„å°ç‰ˆæœ¬å· + 1ï¼Œç›´åˆ°æµ‹è¯•å®Œæ¯•å‘å¸ƒæ­£å¼ç‰ˆ `2.1.3`ã€‚

ç”±äºæ‰“å¼€å°ç¨‹åºåæ²¡æœ‰ä»»ä½•å…³äºç‰ˆæœ¬çš„æç¤ºï¼Œå› æ­¤æˆ‘ä»¬è¿˜åœ¨å°ç¨‹åºé¦–é¡µæ·»åŠ äº†æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬å·çš„å°è§’æ ‡ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜è¿›è¡ŒåŒºåˆ†æ­£åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚è§’æ ‡åœ¨å°ç¨‹åºå¤„äºå¼€å‘ç¯å¢ƒæ—¶æ˜¾ç¤ºï¼Œæ­£å¼ç¯å¢ƒæ—¶éšè—ã€‚

å› æ­¤ `config/env.js` ä¸­éœ€è¦ç»´æŠ¤ä¸¤ä¸ªå¸¸é‡ï¼š

```javascript
export const ENV = 'DEV';
export const VERSION = '2.1.3.d1';
```

è‡³æ­¤ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥ç²¾ç¡®å¾—é’ˆå¯¹æŸä¸ªç‰ˆæœ¬çš„ Bug è¿›è¡Œè®°å½•ï¼Œå¼€å‘äººå‘˜ä¿®å¤åï¼Œä¹Ÿå¯ä»¥è®°å½•åœ¨å“ªä¸ªç‰ˆæœ¬ä¿®å¤å®Œæ¯•ï¼Œæ–¹ä¾¿è¿›è¡Œå›æµ‹ã€‚Niceï¼

---

ä½†è¿™æ˜¯å®Œç¾çš„æ–¹æ¡ˆå—ï¼Ÿè‡³æ­¤ï¼Œæˆ‘ä»¬æ¯æ¬¡å‘å¸ƒæ–°çš„ç‰ˆæœ¬ï¼Œéƒ½éœ€è¦ï¼š

1. ä¿®æ”¹ `config/env.js` ä¸­çš„ç‰ˆæœ¬å·
2. ç‚¹å‡»å¼€å‘è€…å·¥å…·ä¸­çš„ä¸Šä¼ æŒ‰é’®ï¼Œåœ¨ç‰ˆæœ¬å·ä¸€æ ä¸­è¾“å…¥ `config/env.js` ä¸­çš„æ–°ç‰ˆæœ¬å·

è¿™ä¸ªæµç¨‹è¿˜å­˜åœ¨ä»€ä¹ˆç—›ç‚¹å‘¢ï¼Ÿ

1. ç”±äºè¿™ä¸¤ä¸ªæ­¥éª¤éƒ½æ˜¯æ‰‹åŠ¨çš„ï¼Œå¹¶ä¸”å¦‚æœé‡åˆ°é¢‘ç¹å‘å¸ƒæµ‹è¯•ç‰ˆæœ¬çš„æƒ…å†µï¼Œç»å¸¸ä¼šç”±äºç–å¿½å¯¼è‡´è¿™ä¸¤ä¸ªç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œä»ç„¶ä¼šå¼•èµ·æµ‹è¯•äººå‘˜çš„å›°æƒ‘
2. æ¯æ¬¡å‘å¸ƒç‰ˆæœ¬éƒ½è¿™æ ·æ”¹ä¸€é€šï¼Œå¯¹äºå¼€å‘äººå‘˜æ¥è®²ç€å®æ˜¯ä¸€ç§ç—›è‹¦

æˆ‘ä»¬æƒ³è¦è¾¾åˆ°ä»€ä¹ˆæ ·çš„æ•ˆæœï¼Ÿ

1. ä¸€é”®åˆ‡æ¢è¿è¡Œç¯å¢ƒã€‚æ¯æ¬¡å‘å¸ƒé¢„å‘å¸ƒç‰ˆæˆ–æ­£å¼ç‰ˆæ—¶ï¼Œéƒ½éœ€è¦ä¿®æ”¹ ENV çš„å€¼ï¼Œè€Œè¿™ä¸ªå€¼å¿…å®šæ˜¯æœ‰é™çš„å‡ ä¸ªï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥æ›´ç®€å•å¾—ä¿®æ”¹è¿™ä¸ªå€¼
2. è‡ªåŠ¨ç»´æŠ¤å°ç‰ˆæœ¬å·ã€‚ç”±äºå¤§éƒ¨åˆ†æ—¶é—´æˆ‘ä»¬å‘ç‰ˆçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†å†…éƒ¨æµ‹è¯•ï¼Œè€Œç”¨æˆ·æ ‡è®°å†…éƒ¨ç‰ˆæœ¬çš„å°ç‰ˆæœ¬å·åªéœ€è¦è¿›è¡Œç®€å•ç´¯åŠ å³å¯ï¼Œå› æ­¤å®Œå…¨å¯ä»¥è€ƒè™‘æŠŠè¿™ä¸ªè¿‡ç¨‹ç»™è‡ªåŠ¨åŒ–æ‰

æƒ³æ¸…æ¥šè‡ªå·±æƒ³è¦ä»€ä¹ˆä¹‹åï¼Œå¼€æ•´ï¼

## ç¬¬ä¸‰æ­¥ï¼šå¼•å…¥ miniprogram-ci

å®é™…ä¸Šå°ç¨‹åºæä¾›äº† [miniprogram-ci](https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html) æ‰©å±•åŒ…ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨åˆ°å…¶ä¸­çš„â€œä¸Šä¼ â€åŠŸèƒ½ã€‚

ä¸ºäº†æ›´å¥½å¾—å®ç°ç›®çš„ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€å¥—æ–°çš„ç‰ˆæœ¬å·è§„èŒƒï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

1. å°ç¨‹åºè¿è¡Œç¯å¢ƒã€‚DEV, STAGING, PROD
2. å°ç¨‹åºä¸»ç‰ˆæœ¬å·ã€‚2.1.3
3. ç”¨äºå¼€å‘å’Œæµ‹è¯•æ—¶å†…éƒ¨ä½¿ç”¨çš„æ¬¡ç‰ˆæœ¬å·ã€‚1, 2, 3 é€’å¢ã€‚å½“å°ç¨‹åºæ˜¯æ­£å¼ç‰ˆæ—¶ï¼Œæ¬¡ç‰ˆæœ¬å·æ°¸è¿œä¸º 0

ä¸€ä¸ªå®Œæ•´çš„ç‰ˆæœ¬å·ä¾‹å­ï¼š`DEV-2.1.3-4`

æŠ›å»ä½¿ç”¨ miniprogram-ci è‡ªåŠ¨ä¸Šä¼ çš„éƒ¨åˆ†ï¼Œä¸»ç‰ˆæœ¬å·åªéœ€è¦åœ¨å¼€å‘å‰å®šä¹‰ä¸€æ¬¡å³å¯ï¼Œè€Œæ¬¡ç‰ˆæœ¬å·çš„ç»´æŠ¤å®Œå…¨å¯ä»¥é€šè¿‡è¯»å–ä¸Šä¸€æ¬¡çš„ç‰ˆæœ¬ç®€å• +1 å¾—åˆ°ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„ node è„šæœ¬ï¼Œä¸»è¦åŠŸèƒ½å°±æ˜¯è¯»å– env.js çš„å†…å®¹å¹¶ä¿®æ”¹ï¼Œç„¶åè¿›è¡Œä¿å­˜ã€‚å½“ç„¶ï¼Œä¸ºäº†å®ç°æ›´é«˜çš„è‡ªç”±åº¦ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»“åˆå‘½ä»¤è¡Œå‚æ•°ï¼ŒåŠ äº¿ç‚¹ç‚¹çš„ä¿®é¥° ğŸ¤£ã€‚

è¯ä¸å¤šè¯´ç›´æ¥æ”¾ä»£ç ã€‚è„šæœ¬éå¸¸ç®€å•ï¼Œå°±ä¸åšè¿‡å¤šè§£é‡Šäº†ã€‚

```javascript
const fs = require('fs');
const ci = require('miniprogram-ci');
const { appid } = require('./project.config.json');
const { ENV, MAJOR_VERSION, ADORN_VERSION } = require('./src/config/env.cjs');

// =============================================================================
// è®¡ç®—ç‰ˆæœ¬
// =============================================================================

const specifiedEnv = process.argv[2] || 'DEV';
const specifiedMajorVersion = process.argv[3];
const specifiedAdornVersion = process.argv[4];

const buildFullVersion = (env, major, adorn) => `${env}-${major}-${adorn}`;

console.log('\x1b[36m%s\x1b[0m', `Original Version: ${buildFullVersion(ENV, MAJOR_VERSION, ADORN_VERSION)}`);

const nextEnv = (() => {
  if (!specifiedEnv) return ENV;

  if (['DEV', 'd', '1'].includes(specifiedEnv)) {
    return 'DEV';
  } else if (['STAGING', 's', '2'].includes(specifiedEnv)) {
    return 'STAGING';
  } else if (['PROD', 'p', '3'].includes(specifiedEnv)) {
    return 'PROD';
  } else {
    throw 'ERROR ENV!';
  }
})();
const nextMajorVersion = specifiedMajorVersion ? specifiedMajorVersion : MAJOR_VERSION;
const nextAdornVersion = (() => {
  // å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œåˆ™æ­¤ç‰ˆæœ¬å·æ°¸è¿œä¸º 0
  if (nextEnv === 'PROD') {
    return 0;
  }
  // åˆ¤æ–­ä¸»ç‰ˆæœ¬å’Œç¯å¢ƒæ˜¯å¦å˜åŒ–ï¼Œå¦‚æœå˜åŒ–ï¼Œåˆ™é‡ç½®ä¸º 1
  else if (nextMajorVersion !== MAJOR_VERSION || nextEnv !== ENV) {
    return 1;
  }
  // ä¸»ç‰ˆæœ¬æ— å˜åŒ–ï¼Œç‰ˆæœ¬å·é»˜è®¤ + 1
  else {
    return specifiedAdornVersion ? specifiedAdornVersion : +ADORN_VERSION + 1;
  }
})();

const nextFullVersion = buildFullVersion(nextEnv, nextMajorVersion, nextAdornVersion);
console.log('\x1b[36m%s\x1b[0m', `Next Version: ${nextFullVersion}\n`);

// =============================================================================
// ç”Ÿæˆç¯å¢ƒå˜é‡çš„é…ç½®æ–‡ä»¶
// =============================================================================

console.log('\x1b[36m%s\x1b[0m', `Generating the env configuration file...`);

fs.writeFileSync(
  './src/config/env.cjs',
  `module.exports = {
  ENV: '${nextEnv}',
  MAJOR_VERSION: '${nextMajorVersion}',
  ADORN_VERSION: '${nextAdornVersion}'
};\n`,
);

fs.writeFileSync(
  'src/config/env.js',
  `export const ENV = '${nextEnv}';
export const MAJOR_VERSION = '${nextMajorVersion}';
export const ADORN_VERSION = '${nextAdornVersion}';\n`,
);

console.log('\x1b[32m%s\x1b[0m', `Configuration file generated!\n`);

// =============================================================================
// ä¸Šä¼ 
// =============================================================================

console.log('\x1b[36m%s\x1b[0m', `Ready to upload...`);

const project = new ci.Project({
  appid,
  type: 'miniProgram',
  projectPath: './src',
  privateKeyPath: './mp-upload.private.key',
  ignores: ['**/*.d.ts', '**/*.md'],
});

(async () => {
  await ci.upload({
    project,
    version: nextFullVersion,
    desc: `Uploaded at ${new Date().toLocaleString()}`,
    setting: {
      es6: true,
      es7: true,
      minify: true,
      autoPrefixWXSS: true,
    },
    // Tips: å¦‚æœä¸æƒ³çœ‹ä¸€å¤§å †å†—é•¿çš„ logï¼Œå°±åŠ ä¸Šè¿™ä¸€å¥å§
    onProgressUpdate() {},
  });

  console.log('\x1b[32m%s\x1b[0m', `Uploaded! New version is: ${nextFullVersion}`);

  process.exit();
})();
```

å› æ­¤ `config/env.js` å†…å®¹ä¹Ÿå°±å˜æˆäº†ï¼š

```javascript
export const ENV = 'DEV';
export const MAJOR_VERSION = '2.1.3';
export const ADORN_VERSION = '2';
```

æ¥ç€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ package.json ä¸­æ·»åŠ ä¸€æ¡å‘½ä»¤ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ npm è°ƒç”¨äº†ï¼š

```json
"scripts": {
  "upload": "node mp-upload.js"
},
```

è„šæœ¬ä½¿ç”¨ç¤ºä¾‹ï¼š

- `npm run upload`: å–ä¸Šä¸€ä¸ª Envï¼ŒMajorVersion ä¿æŒä¸å˜ï¼ŒAdornVersion + 1
- `npm run upload d`: Env è®¾ä¸ºå¼€å‘ç¯å¢ƒï¼ŒMajorVersion ä¿æŒä¸å˜ï¼ŒAdornVersion + 1
- `npm run upload d 2.1.3`: Env è®¾ä¸ºå¼€å‘ç¯å¢ƒï¼ŒMajorVersion è®¾ä¸ºå‚æ•°ä¸­çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¦‚æœ MajorVersion ä¸å˜ï¼ŒAdornVersion + 1ï¼Œå¦åˆ™é‡ç½®ä¸º 1
- `npm run upload d 2.1.3 1`: Env è®¾ä¸ºå¼€å‘ç¯å¢ƒï¼ŒMajorVersion è®¾ä¸ºå‚æ•°ä¸­çš„ç‰ˆæœ¬ï¼ŒAdornVersion è®¾ä¸ºå‚æ•°ä¸­çš„ç‰ˆæœ¬

Ohhhhhhhhï¼çœ‹èµ·æ¥å¾ˆæ£’ï¼

## è¿˜èƒ½å†æ™ºèƒ½ç‚¹å—ï¼Ÿ

å½“ç„¶ï¼

å°ç¨‹åºå‘ç‰ˆæœ€å¤§çš„ç—›ç‚¹å°±æ˜¯éœ€è¦åœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰‹åŠ¨ä¸Šä¼ ï¼Œä½†æœ‰äº†è¿™ä¸ªè„šæœ¬ï¼Œå°±å¯ä»¥æ¥å…¥ä»»ä½•æˆ‘ä»¬éœ€è¦çš„è‡ªåŠ¨åŒ–æ„å»ºæµç¨‹äº†ï½

æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ç®€å•çš„ Git Hooksï¼Œåœ¨åˆ†æ”¯å¹¶å…¥ develop æ—¶è‡ªåŠ¨æ‰§è¡Œ `npm run upload d` å‘å¸ƒç”¨äºæµ‹è¯•æ–°çš„ä½“éªŒç‰ˆï¼Œå¹¶å…¥ release æ—¶æ‰§è¡Œ `npm run upload s` å‘å¸ƒé¢„å‘å¸ƒç‰ˆï¼Œè€Œå¹¶å…¥ master è‡ªåŠ¨æ‰§è¡Œ `npm run upload p` å‘å¸ƒå‡†å¤‡æäº¤å®¡æ ¸çš„æ­£å¼ç‰ˆã€‚
